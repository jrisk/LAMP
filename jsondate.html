<html>
<head>
    <title>JSON AGENDA VIEW BUILD 2.0</title>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> 
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.14.30/js/bootstrap-datetimepicker.min.js"></script>
<script src="https://raw.githubusercontent.com/enyo/dropzone/master/dist/dropzone.js"></script>

<!-- testing purposes <script src="./testing.js"></script> -->
<!-- newest update makes downloadable build files automatically
<script src="https://modernizr.com/downloads/modernizr-latest.js" 
type="text/javascript"></script> -->

<link href="https://fonts.googleapis.com/css?family=Alegreya:400,700|Karla|Montserrat+Alternates:700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="./lessonplanner.css">
</head>

<body>
	<nav class="nav">Hello</nav>
	<div class="container-fluid" id="json-today"><p id="today-look">Today</p></div>
	<div class="container-fluid" id="json-future"><p id="future-look">Future Plans</p></div>
	<div class="container-fluid" id="json-repeat"></div>
	<div class="container-fluid" id="json-past">Past Plans</div>
	<div class="container" id="json-nest"></div>
	<h2 id="plans"></h2>

</body>
<script>
$(function () {

	//call this function when the new plan div is being made and the first row-cols and act is passed

	function appendActs(elem, objec, stringpls, titleParse, newtemp) {

		//trying to add bootstrap divs...still havent got it down

		if (elem != "#json-today") {

		$(elem).append('<h2 id="plan-day">'
		+ objec[0].date + '</h2>');

		}

		$(elem).append('<div class="container-fluid">'
		+ '<div id="' + stringpls + '" class="plan-big well well-sm">'
		+ '<p id="plan-title">' + newtemp + '</p></div>');
		//not clising the plan-big div until the very end makes it collapse easier it seems
		//end the row since the id '# name + stringpls' will be appended with further columns
		//+ '<div id="plan-start-in" class="col-xs-12 col-sm-4">starts at: '
		//+ moment(objec[i].start).format('HH:mm a')
		//+ '</div></div>');

		$('#' + stringpls).append('<div class="row agenda-act-row well" id="' + objec[i].id + '">'
		+ '<div class="small-type col-xs-12 col-sm-12">'
		+ moment(objec[i].start).format('h:mm a') + '-'
		+ moment(objec[i].end).format('h:mm a') + '</div><div id="specificplan-'
		+ objec[i].title + '" class="specplanners the-first-act col-xs-12 col-sm-12">'
		+ objec[i].title + '</div>'
		+ '<div id="' + objec[i].id + '-media" class="media-objects col-xs-12 col-sm-12"> </div>');

		//$('.plan-big').slideToggle('slow');
		//animate plans to bring them offscreen to on from left

	};

	/*function checkAct(start, currently, end) {
							if (start < currently && currently < end) {
								console.log('all good');
							}

							else {
								console.log('redo ajax fetch data for new current act');
								getData();
							}
							console.log(start + currently + end);
							console.log(start < currently);
							console.log(currently < end);
						}*/

	function getData() {

	$.ajax({
		type: 'GET',
		url: 'datesort.php',
		success: function(data) {

			/** ';;;' as an activity completely screwed this page, DO REGEX AND VALIDATION!!!! */

			var JSONParse = JSON.parse(data);

			// you can only sort an array, not a json object (no key based sort)

			var weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

			console.log(JSONParse);

			//unnecessary to add date, user can see date on phone or is aware of today's date anyway

			//$('#json-today').append(moment().format('dddd') + ' ' + moment().format('YYYY-MM-DD'));

			var currentTime = moment().format(); // or new Date();

			console.log(currentTime);

			var todayPlan = 0;

			$.each(JSONParse, function(ind, obj) {

				// time function for deciding which div fits the current time, or closest to it

				/*if (tempStart < currentTime < tempEnd) {
					var currentAct = obj[i].id;
				}*/

				//further seperate days into subplan-> activity combos

				for (i = 0; i < obj.length; i++) {

					//time get function to compare current time to each time value given in loop

					var tempStart = moment(obj[i].start).format('HH:mm:ss');

					var tempDay =  moment(obj[i].date).format('YYYY-MM-DD');

					var tempUTCstart = tempDay + 'T' + tempStart;

					var UTCstart = moment(tempUTCstart).format();

					var tempEnd = moment(obj[i].end).format('HH:mm:ss');

					var tempUTCend = tempDay + 'T' + tempEnd;

					var UTCend = moment(tempUTCend).format();

					console.log('UTCstart = ' + UTCstart + 'UTCend = ' + UTCend + 'currentTime = ' + currentTime);

					//compare currenttime to start time

					var newtemp = obj[i].plan;

					if (newtemp == oldtemp) { // if current plan equals the last plan

						$('#' + stringpls).append('<div class="row agenda-act-row well" id="' + obj[i].id + '">'
						+ '<div class="small-type col-xs-12 col-sm-12" id="' + UTCend + '">'
						+ moment(obj[i].start).format('h:mm a') + '-'
						+ moment(obj[i].end).format('h:mm a') + '</div>'
						+ '<div id="specificplan-'
						+ obj[i].title + '" class="specplanners col-xs-12 col-sm-12">'
						+ obj[i].title + '</div>'
						+ '<div id="' + obj[i].id + '-media" class="media-objects col-xs-12 col-sm-12" </div>');

					var oldtemp = obj[i].plan;

					//copy this to the starting activity of the other plans
					// or better yet, refactor so there arn't seperate loops for the first act of a plan

					if (UTCstart < currentTime && currentTime < UTCend) {
						$('#' + obj[i].id).parent().addClass('currentPlan');
						$('#' + obj[i].id).addClass('currentAct');
						//$('.plan-big').children().toggle('slow');
						$('body').animate({ scrollTop: $('.currentAct').offset().top }, 1000);
						$('.plan-big').not($('.currentPlan')).children().hide();
						$('.currentAct').css('background-color', '#C6E2FF');

						console.log('console log above set interval says' + UTCstart);

						setInterval(function() {
							console.log('end time = ' + $('.currentAct').children('.small-type').prop('id'));

							}, 5000);
					}

					}

					else { // if no match, it must be a new plan since its given in order

						//make sure any activity goes under the correct sub-div

						for (k = 0; k <= weekDays.length - 1; k++) {

							var planDate = ind;

							var Day = moment(planDate).format('dddd');

							var Today = moment().format('dddd');

							var fullToday = moment().format('YYYY-MM-DD');

						}

						//end the row now that its a new plans

						$('#' + stringpls).append('</div>');

						// make new variables based on new plan and titles

						var stringpls = 'planning' + newtemp.replace(/\s/g, '-');

						var titleParse = 'title: ' + obj[i].title.replace(/\s/g, '-');

						//If Today's Date is the same as one of the plans, put it in the first div 'json-today'

						if (planDate == fullToday) {

							appendActs('#json-today', obj, stringpls, titleParse, newtemp);

							todayPlan = 1;
						}

						// If The Plan is "more than today's date" or in the future, continue on to next div after today

						else if (planDate > fullToday) {

							appendActs('#json-future', obj, stringpls, titleParse, newtemp);

						}

						//If Today's Date is is more than the plan's date, the plan is in the past, and goes into the graveyard/purgatory
						//depending on if the plan has been made to be repeated every weekday that its on, or to other days

						else { // (planDate < fullToday)

							appendActs('#json-past', obj, stringpls, titleParse, newtemp);
				
						}

						// If the Date isnt the same as Today but the Weekdays are, put in the weekday 'repeat' basket

						if (Day == Today) {
						///always use the g flag to match ALL occurences, not just the first one

						//need stringpls here

						$('#json-repeat').append('<h2>' + Today + '\'s Plans</h2>');
						$('#json-repeat').append('<h3>The Plans name is: ' + obj[0].plan + '</h3>');
						
						//var oldtemp = obj[i].plan;
						//var todayplan = 1;
						}

						var oldtemp = obj[i].plan;
					}
				}

			});

			if (todayPlan == 0) {
				$('#json-today').append('<div class="well-sm">No Plans or Files</div>');
			}

			// hide all plans except for the first of the day or current time-based plan
			// hide the activities of each plan

			$('.plan-big').on('click tap', function(e) { //show the activities on click
				e.preventDefault();
				$(this).children().toggle('slow');
				$(this).children('#plan-title').show('slow');
				// show media object line box $(this).
			});

			$('.specplanners').on('click tap', function(e) {
				e.preventDefault();
				e.stopPropagation();
			});

			//$('.plan-big').children().hide();
			$('.plan-big').css('left', '-100%');
			$('.plan-big').animate({left: '0%'}, 800);
			$('#json-future').hide();
			//$('#json-past').hide();

			if ($('.currentPlan').html() && $('.currentAct').html()) {
			console.log($('.currentPlan').html());
			//$('.currentPlan').children().toggle('slow');
			//$('.plan-big').children().toggle('slow');
			//$('body').animate({ scrollTop: $('.currentPlan').offset().top }, 2000);
			//$('body').animate({ scrollTop: $('.currentAct').offset().top }, 1000);
			//$('.currentAct').hide().fadeIn(1000).css('background-color', '#C6E2FF');
			console.log($('.currentPlan').offset().top);
			console.log($('.currentAct').offset().top);
			//$('body').animate({ scrollTop: $('.currentPlan').children('.currentAct').offset().top }, 2000);
			//goToCur();
			}

			else {
				console.log('nuthin right now');
				//go to nearest activity if its tomorrow or whenever
				//keep div on top that says no activities today, offset to bottom of screen the nearest act
			}
		},

		error: function(errorThrown) {
			$('#json-nest').html(errorThrown);
		}
	});

	}

getData();

$('#refresh').on('click tap', function(e) {
	//dont getData breaks stuff
});

function goToCur() {
$('body').animate({ scrollTop: $('.currentAct').offset().top }, 1000);
}

})
</script>

</html>

