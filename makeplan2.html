<!-- appcache deprecated in favor of SERVICE WORKERS <html manifest="offline.appcache"> -->
<html>
<head>
    <title>Lesson Plan V3</title>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> 
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.14.30/js/bootstrap-datetimepicker.min.js"></script>
<script src="./dropzone.js"></script>
<script src="./extrajs.js"></script>

<!-- testing purposes <script src="./testing.js"></script> -->
<!-- deprecated 
<script src="//www.modernizr.com/downloads/modernizr-latest.js" type ="text/javascript"></script>
have to build file yourself now
-->

<link href="http://fonts.googleapis.com/css?family=Montserrat+Alternates:700&subset=latin,latin-ext" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="./lessonplanner.css">
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
               <a href="./calplug.php"><button type="button" class="btn btn-lg btn-primary">Calendar</button></a>
               <a href="./makeplan2.html" class="btn btn-lg btn-primary">New Plan</a>
               <a href="./jsondate.html" class="btn btn-lg btn-primary">Agenda</a>
        </div>
    </nav>

<!-- Insert Saved Plan Name, Class, and Days View-->
<div class="container" id="plan-viewer">
</div>
<!-- End Dynamic Insert on Save -->

<form onsubmit="savePlan()" id="planclassday" method="post" action="formaction.php">

<div class="container" id="container-outer-make">

<!-- insert fore each for activity and stuff here -->

    <div class="row">
        <div class="col-xs-12 col-sm-8">
            <div class="input-group input-group-lg">
                <span class="input-group-addon" id="Plan-Icon">
                            <div class="glyphicon glyphicon-paperclip">
                            </div>
                </span>
    <input name="lesson-name" id="lessonname3" type="text" class="form-control" placeholder="Plan Name">
</div>
</div>
</div>

<br>

 <div class="row">
        <div class="col-xs-12 col-sm-7">
            <div class="input-group input-group-lg">
                <span class="input-group-addon" id="Class-Icon">
                    <span class="glyphicon glyphicon-education">
                    </span>
            </span>
<input name="user-group" type="text" id="classname3" class="form-control" placeholder="Class/Student Name">
</div>
</div>
</div>

<br>

    <div class="row">
        <div class="col-xs-12 col-sm-6">
            <div class="form-group">
                <div class="input-group input-group-lg date" id="datetimepickerplan3">
                        <span class="input-group-addon" id="Date-Icon">
                            <span class="glyphicon glyphicon-calendar">
                            </span>
                        </span>
                    <input type="text" id="dateplan3" placeholder="Day" name="date-plan" class="form-control">
                </div>
<input type="hidden" id="datefix3" name="date-planfix" class="form-control">
</div>
</div>

    <div class="col-xs-6 col-sm-3" id="the-day">Repeat Every <b id="the-real-day"></b></div>
    <div class="btn-group btn-group-lg col-xs-12 col-sm-6" id="checkbox-holder" data-toggle="buttons">
        <label class="btn btn-default checkboxing">
            <input name="every-week" id="weekly" class="week-input" value="everyWeek" type="radio">
            Yes
        </label>
       <label class="btn btn-default checkboxing">
        <input name="every-week" id="one-off" class="week-input" value="notEveryWeek" type="radio">
            No
        </label>
    </div>



<!-- WEEKDAY COPIER/PICKER, ADD LATER 
    <div class="btn-group btn-group-lg col-xs-12 col-sm-6" id="checkbox-holder" data-toggle="buttons">
        <label class="btn btn-default">
            <input name="WeekDays1" id="mon" class="day-input" value="Monday" type="checkbox">Mon
        </label>
        <label class="btn btn-default">
            <input name="WeekDays2" id="tues" class="day-input" value="Tuesday" type="checkbox">Tues
        </label>
        <label class="btn btn-default">
            <input name="WeekDays3" id="wed" class="day-input" value="Wednesday" type="checkbox">Wed
        </label>
        <label class="btn btn-default">
            <input name="WeekDays4" id="thurs" class="day-input" value="Thursday" type="checkbox">Thurs
        </label>
        <label class="btn btn-default">
            <input name="WeekDays5" id="fri" class="day-input" value="Friday" type="checkbox">Fri
        </label>
        <label class="btn btn-default">
            <input name="WeekDays6" id="sat" class="day-input" value="Saturday" type="checkbox">Sat
        </label>
        <label class="btn btn-default">
            <input name="WeekDays7" id="sun" class="day-input" value="Sunday" type="checkbox">Sun
        </label>
    </div>

    <-->
    
</div>

</div>  <!--outer- topdiv container-->

<!-- only saves lesson, class, day. </form> -->

<hr>

<div class="container" id="button-add-save">
    <div class="row">
<div class="col-xs-12 col-md-12">
<button type="button" class="btn btn-lg btn-primary" id="add-plan">Save</button>
</div>
</div>
</div>

<!--Input saved activity row here -->
<div id="actentry"></div> <!-- got activity row after posting to newformaction -> totalview -->

<div class="container" id="label-row">
    <div class="row">
        <div class="col-sm-5 col-xs-12">
            <h4><div class="label label-primary">Activity</div></h4>
        </div>
        <div class="col-sm-2 col-xs-12">
            <h4><div class="label label-warning">Start Time</div></h4>
        </div>
        <div class="col-sm-2 col-xs-12">
            <h4><div class="label label-success">End Time</div></h4>
        </div>
    </div>
</div>

<br>

<div class="container" id="activity-container">
    <!--mobile label in order -->
    <div class="row" id="activity-molab">
        <div class="col-xs-12">
            <h3><div class="label label-primary">Activity</div></h3>
        </div>
    </div>
    <!-- activity label end -->
    <div class="row">
        <div class="col-xs-12 col-sm-5">
            <div class="input-group input-group-lg">
                <span class="input-group-addon" id="Activity-Icon">
                
                    <span class="glyphicon glyphicon-pencil" id="pencil-icon">
                            </span>
                </span>
            <input name="activity" type="text" class="form-control input-lg">
            </div>
        </div>

        <!-- start 2nd row on mobile <div class="row" id="start-time-molab">-->
        <div class="col-xs-12" id="start-time-molab">
            <h3><div class="label label-warning">Start</div></h3>
        </div>
        <!-- end start label row mobile -->
        
        <div class="col-xs-12 col-sm-2">
            <div class="form-group">
                <div class="input-group date" id="starttime3">
                    <span class="input-group-addon" id="Start-Icon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                    <input type="text" class="form-control input-lg" name="start-time" id="start3">
                </div>
            </div>
        </div>

        <!-- end time mobile label <div class="row" id="end-time-molab">-->
        <div class="col-xs-12" id="end-time-molab">
            <h3><div class="label label-success">End</div></h3>
        </div>
        <!--end end time molab -->

        <div class="col-xs-12 col-sm-2">
            <div class="form-group">
                <div class="input-group date" id="endtime3">
                    <span class="input-group-addon" id="End-Icon">
                <span class="glyphicon glyphicon-time"></span>
            </span>
            <input type="text" class="form-control input-lg" name="end-time" id="end3">
        </div>
    </div>
</div>

        <!-- start media molab label divs -->
        <div class="col-xs-12" id="media-molab">
            <h3><div class="label">Media</div></h3>
        </div>
        <!-- end media molab divs -->
        <div class="col-xs-12 col-sm-2">

            <!-- form within a form -->
            <div class="dropzone" id="new-dropzone">
            <!-- <button id="upload-form">Upload</button> -->
            <div class="fallback">
                <input name="file" type="file" multiple />
            </div>


<div id="drop-container" class="dropzone-previews">

</div>

</div>        <!-- end media object input div -->

</div> <!-- end of big row for act, time -->

<div class="container" id="makedelegate"> <!--Buttons for adding more acts or save n go back-->
<div class="row">

<div class="col-sm-4 col-xs-12">
<button type="button" class="btn btn-primary btn-lg" id="add-act">
    Add Activity</button>
</div>

</div> <!-- mini button row at bottom -->
</div> <!-- mini container holding row and bottom buttons -->

</div> <!-- end activity input row container -->

</div> <!-- end form planclassday scope -->

<!-- Comment Container
<div class="container">
    <div class="row">
        <div class="col-sm-4">
            <textarea class="form-control" rows="2" id="comment-note3" name="comment-note"></textarea>
        <input type="hidden" class=" form-control" id="commentnote3" name="commentnote">
        <div class="form-group">
        <input type="hidden" class="form-control" name="duration-time" id="durationtime3">
    </div>
</div>
</div>
</div> END Comment Container-->

<script>
$(function () {

var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;

function widthDecide() {

if (width <= 728) {
    $('#label-row').hide();
}

else {
        $('#activity-molab').hide();
        $('#start-time-molab').hide();
        $('#end-time-molab').hide();
        $('#media-molab').hide();
    }
};

function widthDecideOnShow() {

if (width >= 728) {
    $('#label-row').show();
}

else {
        $('#activity-molab').show();
        $('#start-time-molab').show();
        $('#end-time-molab').show();
        $('#media-molab').show();
    }
};

function widthDecideOnShowCopy() { //delegate/on because of inserted php elements

if (width >= 728) {
    $('.label-row-insert').show();
    $('.activity-insert').hide();
    $('.start-insert').hide();
    $('.end-insert').hide();
}

else {
        $('.label-row-insert').hide();
        $('.activity-insert').show();
        $('.start-insert').show();
        $('.end-insert').show();
        $('.delact-full').hide();
        
    }
};

widthDecide();

$('#label-row').hide();
$('#activity-container').hide(); //start with this hidden unless they want to add stuff now
$('#checkbox-holder').hide(); //start checkbox hidden until receive day input from user
$('#the-day').hide();

$('#add-plan').on('click tap', function() {

    savePlan();
    $('#container-outer-make').hide();
    $('#activity-container').show();
    $('#button-add-save').hide();
    widthDecideOnShow();

    console.log($('#planclassday input').serialize());

    //lessonname3 classname3 dateplan3

    $('#plan-viewer').html("<div class='col-sm-4' id='plan-editor'><h3 id='paperclip-holder'>"  + $('#lessonname3').val() + 
    "</h3><div id='well-plan'></div></div>").hide().fadeIn(1000);
    $('#plan-viewer').append("<div class='col-sm-4' id='class-editor'><h3 id='education-holder'>" + $('#classname3').val() + 
    "</h3><div id='well-class'></div></div>")
    .fadeIn(1000);
    $('#plan-viewer').append("<div class='col-sm-4' id='date-editor'><h3 id='calendar-holder'>" + $('#dateplan3').val() +
    "</h3><div id='well-date'></div></div>")
    .fadeIn(1000);

    //*******************CLICK EVENT HANDLERS TO EDIT PLAN, CLASS, DATE ONCE ALREADY TYPED****************

    //*******************TURN ALL OF THESE FUNCTIONS INTO A CLASS **************************

    function clickEditPlan() {

    $('#plan-viewer').on('click tap', '#plan-editor', function(e) {
        $('#paperclip-holder').html("<span class='glyphicon glyphicon-paperclip'></span>"
        + "<input id='edit-plan' type='text' value='" + $('#lessonname3').val() + "' placeholder='"
        + $('#lessonname3').val() + "'>").hide().fadeIn(1000);
        // turn off click handler when changing focus
        $('#edit-plan').on('focusin', function(e) {
            $('#plan-viewer').off();
            console.log('plan was focused in on');
        });

        // put edit-plan in variable?

        var strLength = $('#edit-plan').val().length * 2;

        $('#edit-plan').focus();

        $('#edit-plan')[0].setSelectionRange(strLength, strLength);

        });
    }

    clickEditPlan();

    $('#plan-editor').on('focusout', function(e) {

        if ($('#edit-plan').val() == "") {
            $('#edit-plan').attr("placeholder", "field cannot be blank");
            console.log("validate this...no plan name typed");
        }

        else {

        $('#lessonname3').val($('#edit-plan').val());
        console.log($('#lessonname3').val());

        $(this).html("<h3 id='paperclip-holder'>"
        + $('#edit-plan').val() + "</h3><div id='well-plan'></div>").hide().fadeIn(1000);
        console.log("did this fire");

        clickEditClass();
        clickEditPlan();
        clickEditDate();

        }

    });

    function clickEditClass() {

    $('#plan-viewer').on('click tap', '#class-editor', function(e) {
        $('#education-holder').html("<span class='glyphicon glyphicon-education'></span>"
        + "<input id='edit-class' type='text' value='" + $('#classname3').val() + "' placeholder='"
        + $('#classname3').val() + "'>").hide().fadeIn(1000);
        // turn off click handler when changing focus
        $('#edit-class').on('focusin', function(e2) {
            $('#plan-viewer').off();
            console.log('class was focused in');
            console.log(e);
            console.log(e2);
        });

        // put edit-plan in variable?

        var strLength = $('#edit-class').val().length * 2;

        $('#edit-class').focus();

        $('#edit-class')[0].setSelectionRange(strLength, strLength);



        });
    }

    clickEditClass();

    $('#class-editor').on('focusout', function(e) {

        if ($('#edit-class').val() == "") {
            $('#edit-class').attr("placeholder", " field cannot be blank");
            console.log("validate this...no class name typed");
            
        }

        else {

        $('#classname3').val($('#edit-class').val());
        console.log($('#classname3').val());

        $(this).html("<h3 id='education-holder'>"
        + $('#edit-class').val() + "</h3><div id='well-class'></div>").hide().fadeIn(1000);

        }

        clickEditClass();
        clickEditPlan();
        clickEditDate();

    });

    // ************************ START OF CLICK DATE EDIT FUNCTION *************************************

    function clickEditDate() {

    $('#plan-viewer').on('click tap', '#date-editor', function(e) {
        $('#calendar-holder').html("<div class='form-group'><div class='input-group input-group-lg date' id='datetimepickeredit3'>"
        + "<span class='glyphicon glyphicon-calendar'></span>"
        + "<input id='edit-date' type='text' value='" + $('#dateplan3').val() + "' placeholder='"
        + $('#dateplan3').val() + "'></div></div>").hide().fadeIn(1000);

        // call datetimepicker now that it exists in the DOM
        datetimefunc3();
        /*$('#datetimepickeredit3').data("DateTimePicker").show(function(e) {
            $('#plan-viewer').off();
        });*/

        // turn off click handler when changing focus
        $('#edit-date').on('focusin', function(e2) {
            $('#plan-viewer').off();
            console.log('the date was focused in');
            });
        });
    }

    clickEditDate();

    $('#date-editor').on('focusout', function(e) {

        $('#dateplan3').val($('#edit-date').val());
        console.log($('#dateplan3').val());

        $(this).html("<h3 id='calendar-holder'>"
        + $('#edit-date').val() + "</h3><div id='well-date'></div>").hide().fadeIn(1000);

        clickEditClass();
        clickEditPlan();
        clickEditDate();

    });

}); //end of (#add-plan) function

function checkboxChange() {

/*$('#checkbox-holder').on('change', '.week-input', function(e) {
    }
});*/

};

//checkboxChange();

function savePlan() {
    $('#planclassday input[type=radio]').each(function(idx, elem) {
        var this_check = $(this).prop('checked');
        var this_day = $(this).val();
        console.log(idx + " = index, ischecked? =" + this_check + " elem: " + this_day);

        if (this_check == true) {
            this_day = this_check;
        }
    });
};

function datetimefunc3() {
$('#datetimepickerplan3').datetimepicker({
    format: 'dddd, MMMM Do',
    allowInputToggle: true
});

$('#datetimepickeredit3').datetimepicker({
    format: 'dddd, MMMM Do',
    allowInputToggle: true,
    focusOnShow: false
});

$('#starttime3').datetimepicker({
    format: 'HH:mm A',
    allowInputToggle: true,
    useCurrent: false,
    focusOnShow: false
});

$('#endtime3').datetimepicker({
    format: 'HH:mm A',
    allowInputToggle: true,
    useCurrent: false,
    focusOnShow: false
});

};

datetimefunc3(); //initialize the date and start/end time pickers

//change event not firing on input item because the dtpicker not initialized until here??

$('input[type=text]').change(function(e) {
    console.log('test on change event for text-type input events');
});

/*$('#endtime3').on('dp.change', function(e) {
    $('#starttime3').data('DateTimePicker').minDate(e.date);
});*/ //link together start and end time to prevent times before being possible

//expose weekly repeat option on day selection

$('#datetimepickerplan3').on('dp.change', function(e) {

    console.log('change event fired on datetimepicker object');

    $('#checkbox-holder, #the-day').show();

    var dayinput = $('#dateplan3').val();

    var daybase = moment(dayinput, 'dddd, MMMM Do');

    var daybaseval = moment(daybase).format('dddd');

    $('#the-real-day').html(daybaseval);

    });
//taken from extra.js editor function for chaning date into mysql readable database date yyyy-mm-dd

var databaseDate = function(element) {
    var dayinput = element.val();

    var daybase = moment(dayinput, 'dddd, MMMM Do');

    var daybaseval = moment(daybase).format('YYYY-MM-DD');

    return daybaseval;
};

$('#add-act').on('click', function() { // click tap may double-post, preventdefault needed?

$('#datefix3').val(databaseDate($('#dateplan3')));

var formdata = $('#planclassday input').serialize();

console.log(formdata);

var plantitle = $('#lessonname3').val();

/*valRegEx = /\.|\-/;

if (valRegEx.test(plantitle) {
    console.log('the plan title can\'t have a period');
    break;
}*/ //test for periods and other symbols...they mess up the database/ php sort parsing

$.ajax({
    type: 'POST',
    datatype: 'json',
    data: formdata,
    url: 'newformaction.php',
    success: function(data) {
        console.log("posted successfully");
        // call another ajax request to GET php file to update activities row
        $.ajax({
            type: 'POST',
            url: 'newtotalview.php',
            data: {planning: plantitle},
            dataType: 'html',
            success: function(datam) {
                $('#actentry').html(datam); //why is this being duplicated? -cuz of start time dupe
                widthDecideOnShowCopy();
                endToStartChange();
                readableStartEnd();
                $('#label-row').hide();
            },

            error: function(errorThrown) {
                console.log(errorThrown);
            }
        });
    },

    error: function(errorThrown) {
        console.log(errorThrown);
    }

});

});

// make start time of next activity the end time of the last activity 

function endToStartChange() {

    var lastend = $('#activity-container-copy .end-time-insert').last().html();

    console.log(lastend);

    var startform = moment(lastend, 'HH:mm:ss');

    var changetime = moment(startform).format('HH:mm A');

    $('#start3').val(changetime);

    $('#end3').val(changetime);

};

// TURN THE START TIME INTO READABLE AM/PM IN VIEW MODE

var startHuman = function(enterstart) {

    var starting = $(enterstart).html();

    var startproto = moment(starting, 'HH:mm:ss');

    var starthuman = moment(startproto).format('hh:mm A');

    return starthuman;
};

// TURN THE END TIME IN READABLE AM/PM MODE

var endHuman = function(enterend) {

    var ending = $(enterend).html();

    var endproto = moment(ending, 'HH:mm:ss');

    var endhuman = moment(endproto).format('hh:mm A');

    return endhuman;
};

//change time into more readable view (2:30pm instead of 14:30:00)

function readableStartEnd() {
    $('.start-time-insert').each(function() {
        var startRead = startHuman($(this));
        $(this).html(startRead);
    });

    $('.end-time-insert').each(function() {
        var endRead = startHuman($(this));
        $(this).html(endRead);
    });
};

$('#actentry').on('click tap', '.delact, .delact-copy', function(e) {

    var actID = $(this).parent().siblings('.activityID').text();

    console.log("current element: " + $(this).html());

    if ($(this).html() == 'delete') {
        var actID = $(this).siblings('.mobileID').text(); //delete button mobile
    };

    var plantitle = $('#lessonname3').val();

    console.log(actID);
    console.log($(this).siblings('.mobileID').text());

    $.ajax({
        type: 'POST',
        url: 'delactivity.php',
        data: {deleteID: actID},
        dataType: 'html',
        success: function(data) {
            $.ajax({
                type: 'POST',
                url: 'newtotalview.php',
                data: {planning: plantitle},
                dataType: 'html',
                success: function(datas) {
                    $('#actentry').html(datas);
                    widthDecideOnShowCopy();
                    console.log("we are in the success part of the new total view...");
                    endToStartChange();
                    readableStartEnd();
                },
                error: function(errorThrown) {
                    console.log(errorThrown);
                }
            });
        },
        error: function(errorThrown) {
            console.log(errorThrown);
        }

    });

});

//delplan and save brings you back to main screen of plans, save state and show activities too?



})

</script>
<script src="./dropcode.js"></script>
</body>
</html>